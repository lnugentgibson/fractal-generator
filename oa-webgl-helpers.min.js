"use strict";var _slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_window=window,angular=_window.angular;angular.module("oaWebglHelpers",[]).service("oaWebglHelpers",function(){function a(){this.FLOAT32=0,this.UINT16=1,this.loadShader=function(a,b,c,d){d||(d=function(a){return console.error(a)});var e=a.createShader(b);return a.shaderSource(e,c),a.compileShader(e),a.getShaderParameter(e,a.COMPILE_STATUS)?e:(d(a.getShaderInfoLog(e)),a.deleteShader(e),null)},this.loadProgram=function(a,b,c,d){d||(d=function(a){return console.error(a)});var e=this.loadShader(a,a.VERTEX_SHADER,b,function(a){d("VERTEXSHADER\n"+a)});if(!e)return d("vertexshader failed to compile"),null;var f=this.loadShader(a,a.FRAGMENT_SHADER,c,function(a){d("FRAGMENTSHADER\n"+a)});if(!e)return d("fragmentshader failed to compile"),null;var g=a.createProgram();return a.attachShader(g,e),a.attachShader(g,f),a.linkProgram(g),a.getProgramParameter(g,a.LINK_STATUS)?g:(d(a.getProgramInfoLog(g)),null)}}return new a}).service("oaWebglShaderHelpers",function(){function a(){this.precision=9,this.orthagonalBasis=function(a){var b=a.inA,c=a.outA,d=a.inB,e=a.outB,f=a.c,g=a.swap;return"vec4 "+c+" = vec4(normalize("+b+".xyz), 0.0);\nvec4 "+f+" = vec4(normalize(cross(normalize("+d+").xyz, cz.xyz)), 0.0);\nvec4 "+e+" = vec4(normalize(cross("+(g?f:c)+".xyz, "+(g?c:f)+".xyz)), 0.0);"},this.cameraMatrix=function(a){var b=Object.assign({cameraPosition:"camP",cameraDirection:"camZ",cameraUp:"camY",matrix:"cameraMatrix",normalizedDirection:"cz",normalizedUp:"cy",right:"cx"},a),c=b.cameraPosition,d=b.cameraDirection,e=b.cameraUp,f=b.matrix,g=b.normalizedDirection,h=b.normalizedUp,i=b.right,j=this.orthagonalBasis({inA:d,outA:g,inB:e,outB:h,c:i,swap:!0});return j+"\nmat4 "+f+" = inverse(mat4(cx, cy, cz, vec4(vec3(0.0), 1.0))) * mat4(vec4(1.0, vec3(0.0)), vec4(0.0, 1.0, vec2(0.0)), vec4(vec2(0.0), 1.0, 0.0), vec4(-"+c+".xyz, 1.0))"},this.projectionMatrix=function(a){var b=Object.assign({fov:"fov",far:"far",near:"near"},a),c=b.fov,d=b.far,e=b.near;return"mat4(vec4(1.0 / tan("+c+".x / 2.0), vec3(0.0)), vec4(0.0, 1.0 / tan("+c+".y / 2.0), vec2(0.0)), ve4(vec2(0.0), -("+d+" + "+e+") / ("+d+" - "+e+"), -1.0), vec4(vec2(0.0), -"+d+" * "+e+" / ("+d+" - "+e+"), 0.0));"}}return new a}).factory("oaWebglShaderSnippet",function(){function a(){function b(a,b){var c,d=this,e=b||"";Object.defineProperties(this,{type:{get:function(){return"value"}},value:{get:function(){var a=c||e;return a},set:function(a){c=a}},parameters:{get:function(){return d.value}}}),this.getValue=function(a){return d.value}}function c(a,b,c,d){var e,f=this,g=b||"",h=c||"",i=d||"";Object.defineProperties(this,{type:{get:function(){return"array"}},value:{get:function(){return e&&e.length?e.map(function(a){return null!=a?a:i}).join(g):h},set:function(a){if(void 0!=a.length){e=[];for(var b=0;b<a.length;b++)e[b]=a[b]}}},parameters:{get:function(){return f.value}},delimeter:{get:function(){return g},set:function(a){g=a?a.toString():""}},emptyString:{get:function(){return h},set:function(a){h=a?a.toString():""}},defaultElementValue:{get:function(){return i},set:function(a){i=a?a.toString():""}}}),this.getValue=function(a){return f.value}}function d(b,c,d,e){var f,g=c||"",h=!!d,i={};Object.defineProperties(this,{type:{get:function(){return"snippet"}},value:{get:function(){return f?f.generate(h?Object.assign({},e.getParameters(),i):i):g},set:function(b){b instanceof a&&(f=b)}},parameters:{get:function(){return i}},nullString:{get:function(){return g},set:function(a){g=a?a.toString():""}}}),this.getValue=function(a){return f?f.generate(h?Object.assign({},e.getParameters(),i,a):Object.assign({},i,a)):g}}function g(a,g){var h={},k=a.match(e);k&&k.map(function(a){return a.match(f)}).forEach(function(a){var c=_slicedToArray(a,6),d=c[2],e=c[5];h[d]||(h[d]=new b(d,e))});var l=a.match(i);l&&l.map(function(a){return a.match(j)}).forEach(function(a){var b=_slicedToArray(a,11),d=b[3],e=b[6],f=b[8],g=b[10];h[d]||(h[d]=new c(d,e,f,g))});var o=a.match(m);return o&&o.map(function(a){return a.match(n)}).forEach(function(a){var b=_slicedToArray(a,9),c=b[3],e=b[6],f=b[8];h[c]||(h[c]=new d(c,e,f,g))}),h}function h(a,b){var c,d=Object.assign({indent:0,indentationStr:"  ",lineNumbers:!1,lineNumberWidth:4},b),e=d.indent,f=d.indentationStr,g=d.lineNumbers,h=d.lineNumberWidth,i="";for(c=0;e>c;c++)i+=f;var j="";for(c=0;h>c;c++)j+="0";return a.split(/\n/g).map(function(a,b){var c=g?(j+(b+1)).substr(-h,h)+": ":"";return c+i+a}).join("\n")}function k(a,b,c){return a=a.replace(m,function(a,c,d,e){var f=e;return b.hasOwnProperty(f)?c+b[f]:a}),a=a.replace(i,function(a,c,d,e){var f=e;return b.hasOwnProperty(f)?c+b[f]:a}),a=a.replace(e,function(a,c,d){var e=d;return b.hasOwnProperty(e)?c+b[e]:a})}var l,o,p=this;this.generate=function(a,b){var c=Object.assign({},p.getParameters(),a),d=Object.assign({},c,b);return h(k(l,c,d),d)},this.applyParams=function(a){var b={};Array.isArray(a)?a.forEach(function(a){o.hasOwnProperty(a)&&(b[a]=o[a].parameters,delete o[a])}):Object.keys(a).forEach(function(c){o.hasOwnProperty(c)&&(b[c]=a[c],delete o[c])}),l=k(l,b)},Object.defineProperty(this,"source",{get:function(){return l},set:function(a){l=a,o=g(a)}}),this.getParameter=function(a){return o[a].value},this.getParameterType=function(a){return o[a].type},this.setParameter=function(a,b){o.hasOwnProperty(a)&&(o[a].value=b)},this.getParameters=function(){var a={};return Object.keys(o).forEach(function(b){a[b]=o[b].parameters}),a},this.getParameterValues=function(){var a={};return Object.keys(o).forEach(function(b){a[b]=o[b].value}),a},this.getParameterNames=function(){return Object.keys(o)}}var b=/(^|[^\$])\$/,c=/[a-z]([-_a-z0-9]*[a-z0-9])?/,d=/(:([^}]+)?)?/,e=new RegExp(b.source+"{("+c.source+")"+d.source+"}","ig"),f=new RegExp(b.source+"{("+c.source+")"+d.source+"}","i"),g=/(array|arr|a):/,h=/(:([^}:]+)?(:([^}:]+)?(:([^}:]+)?)?)?)?/,i=new RegExp(b.source+"{"+g.source+"("+c.source+")"+h.source+"}","ig"),j=new RegExp(b.source+"{"+g.source+"("+c.source+")"+h.source+"}","i"),k=/(snippet|s):/,l=/(:[^}]+(:([^}:]+)?)?)?/,m=new RegExp(b.source+"{"+k.source+"("+c.source+")"+l.source+"}","ig"),n=new RegExp(b.source+"{"+k.source+"("+c.source+")"+l.source+"}","i");return a}).factory("oaWebglShaderSource",function(){function a(a,b,c){var d=a,e=b,f=c||[],g={};this.printShader=function(a){console.log(d.split(/\n/g).map(function(a,b){return("0000"+(b+1)).substr(-4,4)+": "+a}).join("\n"))},this.getParameter=function(a){return g[a]},this.setParameter=function(a,b){g[a]=b},this.generate=function(){if(!e)return d;var a={};return f.forEach(function(b){a[b]=g[b]}),d=e.call(a,a)},Object.defineProperties(this,{source:{get:function(){return d},set:function(a){d=a}},generator:{get:function(){return e},set:function(a){e=a}},parameterNames:{get:function(){return f}},type:{get:function(){return e?g&&g.length?"dynamic":"generated":"static"}}})}return a}).factory("oaWebglProgram",["oaWebglHelpers","oaWebglShaderSource",function(a,b){function c(c){var d,e=this,f=Object.assign({},c),g=!0,h=f.vertexSource instanceof b?f.vertexSource:new b(f.vertexSource),i=f.fragmentSource instanceof b?f.fragmentSource:new b(f.fragmentSource),j=f.attributes,k=f.uniforms,l=f.buffers,m=f.textures,n=f.draw||f.executor,o={},p={},q={},r={},s={},t={};h.parameterNames.forEach(function(a){Object.defineProperty(s,a,{get:h.getParameter(a),set:function(b){h.setParameter(a,b),g=!0}})}),i.parameterNames.forEach(function(a){Object.defineProperty(t,a,{get:i.getParameter(a),set:function(b){i.setParameter(a,b),g=!0}})}),Object.defineProperties(this,{vertexSource:{get:function(){return h},set:function(a){h=a instanceof b?a:new b(a),g=!0}},fragmentSource:{get:function(){return i},set:function(a){i=a instanceof b?a:new b(a),g=!0}},vertexShaderParameters:{get:function(){return s}},vParams:{get:function(){return s}},fragmentShaderParameters:{get:function(){return t}},fParams:{get:function(){return t}},program:{get:function(){return d}}}),this.initialize=function(b){var c=this;if(g){console.log("program.initialize");var e=h.generate(),f=i.generate();d=a.loadProgram(b,e,f),Object.keys(j).forEach(function(a){var e=j[a],f=e.name,g=b.getAttribLocation(d,f),h="a"+a.charAt(0).toUpperCase()+a.substr(1,a.length),i=h+"Spec";c[h]=g,o[h]=g,c[i]=e}),Object.keys(k).forEach(function(a){var e=k[a],f=e.name,g=b.getUniformLocation(d,f),h="u"+a.charAt(0).toUpperCase()+a.substr(1,a.length),i=h+"Spec";c[h]=g,p[h]=g,c[i]=e}),Object.keys(l).forEach(function(d){var e=l[d],f=e.data,g=e.datatype,h=e.target,i=e.usage,j=(e.name,e.attribute),k=b.createBuffer();b.bindBuffer(b[h],k);var m="b"+d.charAt(0).toUpperCase()+d.substr(1,d.length),n=m+"Spec";switch(c[m]=k,q[m]=k,c[n]=e,g){case a.FLOAT32:e.Data=new Float32Array(f);break;case a.UINT16:e.Data=new Uint16Array(f);break;default:console.error("invalid datatype")}if(console.log({bufferId:d,data:f,Data:e.Data}),b.bufferData(b[h],e.Data,b[i]),e.applied=!0,e._data=e.data,Object.defineProperty(e,"data",{get:function(){return e._data},set:function(b){var c=e._data=b;if(b){switch(g){case a.FLOAT32:e.Data=new Float32Array(c);break;case a.UINT16:e.Data=new Uint16Array(c);break;default:console.error("invalid datatype")}console.log({bufferId:d,data:c,Data:e.Data}),e.applied=!1}}}),j){var o="a"+j.charAt(0).toUpperCase()+j.substr(1,j.length),p=o+"Spec",r=c[p];r.buffer=d}}),Object.keys(m).forEach(function(a){var d=m[a],e=d.image,f=d.type,g=(d.name,b.createTexture());b.bindTexture(b.TEXTURE_2D,g),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b[f],e);var h="t"+a.charAt(0).toUpperCase()+a.substr(1,a.length),i=h+"Spec";c[h]=g,r[h]=g,c[i]=d}),g=!1,console.log("program.initialized")}},this.pushAttribute=function(a,b){console.log(Object.keys(this));var c="a"+b.charAt(0).toUpperCase()+b.substr(1,b.length),d=c+"Spec",e=this[c],f=this[d];console.log({attributeId:b,attributeKey:c,attributeSpeckey:d,attributeSpec:f});var g=f.buffer,h="b"+g.charAt(0).toUpperCase()+g.substr(1,g.length),i=h+"Spec",j=this[h],k=this[i];console.log({bufferId:g,bufferKey:h,bufferSpeckey:i,bufferSpec:k});var l=k.numComponents,m=k.type,n=k.normalize,o=k.stride,p=k.offset,q=k.target;a.bindBuffer(a[q],j),a.vertexAttribPointer(e,l,a[m],n,o,p),a.enableVertexAttribArray(e)},this.draw=function(a){console.log("program.draw"),e.initialize(a),Object.keys(l).forEach(function(b){var c=l[b];!c.applied&&c.Data&&a.bufferData(a[c.target],c.Data,a[c.usage])}),n?(console.log("program.execute"),n.call(e,a)):console.log("!executor"),console.log("program.drawn")}}return c}]).factory("oaWebglCanvas",function(){function a(a,b,c){var d,e,f=Object.assign({},c),g={},h=function(){b?(f.width&&f.height&&(b.width=f.width,b.height=f.height),d=b.getContext("webgl")):d=null};h(),Object.defineProperties(this,{canvas:{get:function(){return b},set:function(a){b=a,h()}},gl:{get:function(){return d}},main:{get:function(){return e},set:function(a){g[a]&&(e=a)}}}),this.registerProgram=function(a,b){g[a]=b,d&&b.initialize(d)},this.draw=function(a){if(console.log("canvas.draw"),d){a||(a=e?e:"main");var b=g[a];b&&b.draw(d)}console.log("canvas.drawn")}}return a});