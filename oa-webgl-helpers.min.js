"use strict";var _window=window,angular=_window.angular,_=_window._;angular.module("oaWebglHelpers",["oaObject"]).service("oaWebglHelpers",function(){function a(){this.FLOAT32=0,this.UINT16=1,this.loadShader=function(a,b,c,d){d||(d=function(a){return console.error(a)});var e=a.createShader(b);return a.shaderSource(e,c),a.compileShader(e),a.getShaderParameter(e,a.COMPILE_STATUS)?e:(d(a.getShaderInfoLog(e)),a.deleteShader(e),null)},this.loadProgram=function(a,b,c,d){d||(d=function(a){return console.error(a)});var e=this.loadShader(a,a.VERTEX_SHADER,b,function(a){d("VERTEXSHADER\n"+a)});if(!e)return d("vertexshader failed to compile"),null;var f=this.loadShader(a,a.FRAGMENT_SHADER,c,function(a){d("FRAGMENTSHADER\n"+a)});if(!e)return d("fragmentshader failed to compile"),null;var g=a.createProgram();return a.attachShader(g,e),a.attachShader(g,f),a.linkProgram(g),a.getProgramParameter(g,a.LINK_STATUS)?g:(d(a.getProgramInfoLog(g)),null)}}return new a}).service("oaWebglShaderHelpers",function(){function a(){this.precision=9,this.orthagonalBasis=function(a){var b=a.inA,c=a.outA,d=a.inB,e=a.outB,f=a.c,g=a.swap;return"vec4 "+c+" = vec4(normalize("+b+".xyz), 0.0);\nvec4 "+f+" = vec4(normalize(cross(normalize("+d+").xyz, cz.xyz)), 0.0);\nvec4 "+e+" = vec4(normalize(cross("+(g?f:c)+".xyz, "+(g?c:f)+".xyz)), 0.0);"},this.cameraMatrix=function(a){var b=Object.assign({cameraPosition:"camP",cameraDirection:"camZ",cameraUp:"camY",matrix:"cameraMatrix",normalizedDirection:"cz",normalizedUp:"cy",right:"cx"},a),c=b.cameraPosition,d=b.cameraDirection,e=b.cameraUp,f=b.matrix,g=b.normalizedDirection,h=b.normalizedUp,i=b.right,j=this.orthagonalBasis({inA:d,outA:g,inB:e,outB:h,c:i,swap:!0});return j+"\nmat4 "+f+" = inverse(mat4(cx, cy, cz, vec4(vec3(0.0), 1.0))) * mat4(vec4(1.0, vec3(0.0)), vec4(0.0, 1.0, vec2(0.0)), vec4(vec2(0.0), 1.0, 0.0), vec4(-"+c+".xyz, 1.0))"},this.projectionMatrix=function(a){var b=Object.assign({fov:"fov",far:"far",near:"near"},a),c=b.fov,d=b.far,e=b.near;return"mat4(vec4(1.0 / tan("+c+".x / 2.0), vec3(0.0)), vec4(0.0, 1.0 / tan("+c+".y / 2.0), vec2(0.0)), ve4(vec2(0.0), -("+d+" + "+e+") / ("+d+" - "+e+"), -1.0), vec4(vec2(0.0), -"+d+" * "+e+" / ("+d+" - "+e+"), 0.0));"}}return new a}).factory("oaWebglSnippet",["oaObject",function(){function Snippet(name,source){function render(a,b){var c,d=Object.assign({indent:0,indentationStr:"  ",lineNumbers:!1,lineNumberWidth:4},b),e=d.indent,f=d.indentationStr,g=d.lineNumbers,h=d.lineNumberWidth,i="";for(c=0;e>c;c++)i+=f;var j="";for(c=0;h>c;c++)j+="0";return a.split(/\n/g).map(function(a,b){var c=g?(j+(b+1)).substr(-h,h)+": ":"";return c+i+a}).join("\n")}function applyParams(string,_params,touch){function O(a){var b=specifiers[a];if("a"===b.parameterType){var c=params[a],d=c?c:{};return d}}function A(a){var b=specifiers[a];if("a"===b.parameterType){var c=params[a],d=c&&c.length?c.map(function(a){return null!=a?a:b.nullElement}):[];return d}}function P(a){var b,c=specifiers[a];if("a"===c.parameterType){var d=params[a];b=d&&d.length?d.map(function(a){return null!=a?a:c.nullElement}).join(c.delimiter):c.nullArray}else{var e=params[a];b=void 0==e?c.nullValue:e}return b}function S(a,b){var c,d=specifiers[b];return c="a"===d.parameterType?params[b]?params[b].map(function(b){return snippets[a].generate(b)}).join(d.delimiter):"":snippets[a].generate(params[b])}function D(a,b){var c,d=specifiers[b],e=specifiers[a];return c="a"===e.parameterType&&"a"===d.parameterType?"":"a"===d.parameterType?params[b]?params[b].map(function(b){return snippets[a].generate(b)}).join(d.delimiter):"":"a"===e.parameterType?params[a]?params[a].map(function(a){return snippets[a].generate(params[b])}).join(e.delimiter):"":snippets[a].generate(params[b])}function apply(exp){return eval(exp)}var params=Object.assign({},_params),out=string.replace(expressionRegexGlobal,function(a,b,c){var d,e=b,f=c,g=f.match(parameterReferenceRegexGlobal)||[],h=f.match(arrayReferenceRegexGlobal)||[],i=f.match(snippetReferenceRegexGlobal)||[],j=f.match(dynamicSnippetReferenceRegexGlobal)||[],k=g.map(function(a){return a.match(parameterReferenceRegex)}),l=h.map(function(a){return a.match(arrayReferenceRegex)}),m=i.map(function(a){return a.match(snippetReferenceRegex)}),n=j.map(function(a){return a.match(dynamicSnippetReferenceRegex)}),o=k.map(function(a){return{data:a,ref:a[1],match:!!specifiers[a[1]]}}),p=l.map(function(a){return{data:a,ref:a[1],match:!!specifiers[a[1]]}}),q=m.map(function(a){return{data:a,sref:a[1],pref:a[3],snippetsmatch:!!snippets[a[1]],specifiersmatch:!!specifiers[a[3]],paramsmatch:!!params[a[3]],match:!!snippets[a[1]]&&!!specifiers[a[3]]}}),r=n.map(function(a){var b=!!specifiers[a[1]],c=!0;return b&&parameters[a[1]]&&(c=parameters[a[1]].every(function(a){return!!snippets[a]})),{data:a,sref:a[1],pref:a[3],snippetmatch:b,snippetsmatch:c,specifiersmatch:!!specifiers[a[3]],match:b&&c&&!!specifiers[a[3]]}}),s=o.every(function(a){return a.match}),t=p.every(function(a){return a.match}),u=q.every(function(a){return a.match}),v=r.every(function(a){return a.match});return d=s&&t&&u&&v?e+apply.call({P:P,A:A,S:S,D:D},f):touch?e:a});return out}function objectify(a){function b(a,c,d){a.getKeys().map(function(a){return{key:a,full:d+a}}).map(function(a){return Object.assign(a,{spec:specifiers[a.full]})}).filter(function(a){return a.spec||console.log(JSON.stringify({key:a},null,2)),"o"===a.spec.parameterType}).forEach(function(d){var e=c[d.key],f=c.getKeys().filter(function(a){return a.startsWith(d.key+".")});f.length&&(e||(e=c[d.key]={}),f.forEach(function(a){var b=c[a];delete c[a],a=a.replace(d.key+".",""),e[a]=b}),b(a[d.key],e,d.full+"."))})}if(!a)return{};var c=Object.assign({},a);return b(objectKeys,c,""),c}var _this=this,specifiers={"null":{type:"o"},indent:{type:"int",nullValue:0},indentationStr:{type:"str",nullValue:"  "},lineNumbers:{type:"bool",nullValue:!1},lineNumberWidth:{type:"int",nullValue:4}},objectKeys={"null":{},indent:!0,indentationStr:!0,lineNumbers:!0,lineNumberWidth:!0},parameters={},snippets={};this.addParameter=function(a,b,c,d){var e=Object.assign({replace:!1},d),f=e.replace,g=e.ignore;if(specifiers[b]){if(g)return;if(!f)throw"parameter "+b+" already exists"}for(var h,i=b.split("."),j=objectKeys,k=0;k+1<i.length;k++)h=j[i[k]],h||(h=j[i[k]]={}),j=h;switch(i.length>1&&_this.addParameter("o",i.slice(0,i.length-1).join("."),null,{ignore:!0}),c=Object.assign({},c),a){case"o":case"object":specifiers[b]=Object.assign({parameterType:"o",type:"default",nullObject:"",nullProperty:""},c.filter(["type","nullObject","nullProperty"])),void 0==j[i[i.length-1]]&&(j[i[i.length-1]]={});break;case"a":case"arr":case"array":specifiers[b]=Object.assign({parameterType:"a",type:"default",nullArray:"",nullElement:"",delimiter:"",prefix:"",suffix:""},c.filter(["type","nullArray","nullElement","delimiter","prefix","suffix"])),j[i[i.length-1]]=!0;break;case"v":case"val":case"value":default:specifiers[b]=Object.assign({parameterType:"v",type:"default",nullValue:""},c),j[i[i.length-1]]=!0}},this.setParameter=function(a,b){specifiers[a]&&(parameters[a]=b)},this.addSnippet=function(a,b){if(snippets[a])throw"snippet already exists";snippets[a]=b},this.addSnippets=function(a){_(a).each(function(a,b){_this.addSnippet(b,a)})},this.setSnippet=function(a,b){snippets[a]=b},this.sddSnippets=function(a){_(a).each(function(a,b){_this.sddSnippet(b,a)})},this.generate=function(a){if(!source)throw"snippet "+name+" does not have a non-null source.";var b=objectify(parameters),c=a?a.filter(specifiers.getKeys()):null,d=c?c.filter(objectKeys):null,e=d?objectify(d):null,f=Object.assign({},b,e);return render(applyParams(source,f,!0),f)},this.applyParams=function(a){var b=Array.isArray(a)?parameters.filter(a):a.filter(parameters.getKeys());source=applyParams(source,b)},Object.defineProperty(this,"source",{get:function(){return source},set:function(a){source=a}})}var parameterMarker=/(^|[^\$])\$/,expressionRegexGlobal=new RegExp(parameterMarker.source+"{([^}]+)}","ig"),parameterReferenceRegexString=/P\("([a-z][_a-z0-9]*(\.[a-z][_a-z0-9]*)*)"\)/,parameterReferenceRegexGlobal=new RegExp(parameterReferenceRegexString.source,"ig"),parameterReferenceRegex=new RegExp(parameterReferenceRegexString.source,"i"),arrayReferenceRegexString=/A\("([a-z][_a-z0-9]*(\.[a-z][_a-z0-9]*)*)"\)/,arrayReferenceRegexGlobal=new RegExp(arrayReferenceRegexString.source,"ig"),arrayReferenceRegex=new RegExp(arrayReferenceRegexString.source,"i"),snippetReferenceRegexString=/S\("([a-z][_a-z0-9]*(\.[a-z][_a-z0-9]*)*)", *"([a-z][_a-z0-9]*(\.[a-z][_a-z0-9]*)*)"\)/,snippetReferenceRegexGlobal=new RegExp(snippetReferenceRegexString.source,"ig"),snippetReferenceRegex=new RegExp(snippetReferenceRegexString.source,"i"),dynamicSnippetReferenceRegexString=/D\("([a-z][_a-z0-9]*(\.[a-z][_a-z0-9]*)*)", *"([a-z][_a-z0-9]*(\.[a-z][_a-z0-9]*)*)"\)/,dynamicSnippetReferenceRegexGlobal=new RegExp(dynamicSnippetReferenceRegexString.source,"ig"),dynamicSnippetReferenceRegex=new RegExp(dynamicSnippetReferenceRegexString.source,"i");return Snippet}]).factory("oaWebglFunctionSnippet",["oaWebglSnippet",function(a){function b(b,c,d){var e=this;a.call(this,b+"Def");var f,g,h=function(){return'${S("signiture", "signiture")} {\n'+("string"===d?'${P("bodyString")}':'${S("body", "body")}')+"\n}"};this.source=h();var i=new a(b+"Dec");i.source='${S("signiture", "signiture")};';var j=new a(b+"Signiture");j.source='${P("returnType")} ${P("funcName")}(${S("parameter", "parameterList")})',j.addParameter("v","returnType",{type:"str",nullValue:"float"}),j.addParameter("v","funcName",{type:"str"}),j.addParameter("a","parameterList",{delimiter:", "});var k=new a(b+"Parameter");k.source='${P("datatype")} ${P("paramname")}',k.addParameter("v","datatype",{type:"str",nullValue:"float"}),k.addParameter("v","paramname",{type:"str"}),j.addSnippet("parameter",k),this.addSnippet("signiture",j),i.addSnippet("signiture",j);var l={names:[],order:[]};l.add=function(a,b,c){if(l.names.indexOf(a)>-1&&apples["throw"](),void 0==c)c=l.order.length;else if(l.order[c])throw"index already in use";l.names.push(a),l.order[c]=l[a]={datatype:b,paramname:a,index:c}},l.addMultiple=function(a){var b=l.order.length;a.forEach(function(a,c){var d=a.paramname,e=a.datatype,f=a.index;l.add(d,e,void 0==f?b+c:f)})},l.apply=function(){e.setParameter("signiture.parameterList",l.order),i.setParameter("signiture.parameterList",l.order)},this.addParameter("v","signiture.returnType",{type:"str",nullValue:"float"}),this.setParameter("signiture.returnType",c),this.addParameter("v","signiture.funcName",{type:"str"}),this.setParameter("signiture.funcName",b),this.addParameter("a","signiture.parameterList",{delimiter:", "}),i.addParameter("v","signiture.returnType",{type:"str",nullValue:"float"}),i.setParameter("signiture.returnType",c),i.addParameter("v","signiture.funcName",{type:"str"}),i.setParameter("signiture.funcName",b),i.addParameter("a","signiture.parameterList",{delimiter:", "}),this.addParameter("v","bodyString",{type:"str"}),this.addParameter("v","body.indent",{type:"int",nullValue:1}),this.setParameter("body.indent",1),Object.defineProperties(this,{bodySnippet:{get:function(){return f},set:function(a){f=a,e.setSnippet("body",f)}},bodyString:{get:function(){return g},set:function(a){g=a,e.setParameter("body",g)}},bodyType:{get:function(){return d},set:function(a){("string"===a||"snippet"===a)&&(d=a,e.source=h())}},parameters:{get:function(){return l}},declarationSnippet:{get:function(){return i}},returnType:{get:function(){return c},set:function(a){c=a,e.setParameter("signiture.returnType",c),i.setParameter("signiture.returnType",c)}},funcName:{get:function(){return b},set:function(a){b=a,e.setParameter("signiture.funcName",b),i.setParameter("signiture.funcName",b)}}})}return b}]).factory("oaWebglShaderSnippet",["oaWebglSnippet",function(a){function b(b){var c=this;a.call(this,b),this.source='precision ${P("precision")} float;\n${S("variable", "variables")}\n${D("functionDeclarations", "null")}\nvoid main() {\n${S("body", "body")}\n}\n${D("functionDefinitions", "null")}',this.addParameter("v","precision",{type:"str",nullValue:"mediump"}),this.addParameter("a","variables",{delimiter:"\n"}),this.addParameter("a","functionDeclarations",{delimiter:"\n"}),this.addParameter("a","functionDefinitions",{delimiter:"\n"}),this.addParameter("v","body.indent",{type:"int",nullValue:1}),this.setParameter("body.indent",1);var d={names:[],order:[]};d.add=function(a,b,c,e){if(d.names.indexOf(a)>-1)throw"parameter already exists";if(void 0==e)e=d.order.length;else if(d.order[e])throw"index already in use";d.names.push(a),d.order[e]=d[a]={vartype:b,datatype:c,varname:a,index:e}},d.addMultiple=function(a){var b=d.order.length;a.forEach(function(a,c){var e=a.varname,f=a.vartype,g=a.datatype,h=a.index;d.add(e,f,g,void 0==h?b+c:h)})},d.apply=function(){c.setParameter("variables",d.order)};var e=new a;e.source='${P("vartype")} ${P("datatype")} ${P("varname")};',e.addParameter("v","datatype",{type:"str",nullValue:"float"}),e.addParameter("v","vartype",{type:"str",nullValue:"attribute"}),e.addParameter("v","varname",{type:"str"}),this.addSnippet("variable",e);var f,g=[];this.addFunction=function(a){g.push(a),c.addSnippet("declaration"+g.length,a.declarationSnippet),c.addSnippet("definition"+g.length,a),c.setParameter("functionDeclarations",_.times(g.length,function(a){return"declaration"+(a+1)})),c.setParameter("functionDefinitions",_.times(g.length,function(a){return"definition"+(a+1)}))},this.addFunctions=function(a){a.forEach(function(a){c.addFunction(a)})},Object.defineProperties(this,{variables:{get:function(){return d}},mainSnippet:{get:function(){return f},set:function(a){f=a,c.setSnippet("body",f)}}})}return b}]).factory("oaWebglShaderSource",function(){function a(a,b,c){var d=a,e=b,f=c||[],g={};this.printShader=function(a){console.log(d.split(/\n/g).map(function(a,b){return("0000"+(b+1)).substr(-4,4)+": "+a}).join("\n"))},this.getParameter=function(a){return g[a]},this.setParameter=function(a,b){g[a]=b},this.generate=function(){if(!e)return d;var a={};return f.forEach(function(b){a[b]=g[b]}),d=e.call(a,a)},Object.defineProperties(this,{source:{get:function(){return d},set:function(a){d=a}},generator:{get:function(){return e},set:function(a){e=a}},parameterNames:{get:function(){return f}},type:{get:function(){return e?g&&g.length?"dynamic":"generated":"static"}}})}return a}).factory("oaWebglProgram",["oaWebglHelpers","oaWebglShaderSource",function(a,b){function c(c){var d,e=this,f=Object.assign({},c),g=!0,h=f.vertexSource instanceof b?f.vertexSource:new b(f.vertexSource),i=f.fragmentSource instanceof b?f.fragmentSource:new b(f.fragmentSource),j=f.attributes,k=f.uniforms,l=f.buffers,m=f.textures,n=f.draw||f.executor,o={},p={},q={},r={},s={},t={};h.parameterNames.forEach(function(a){Object.defineProperty(s,a,{get:h.getParameter(a),set:function(b){h.setParameter(a,b),g=!0}})}),i.parameterNames.forEach(function(a){Object.defineProperty(t,a,{get:i.getParameter(a),set:function(b){i.setParameter(a,b),g=!0}})}),Object.defineProperties(this,{vertexSource:{get:function(){return h},set:function(a){h=a instanceof b?a:new b(a),g=!0}},fragmentSource:{get:function(){return i},set:function(a){i=a instanceof b?a:new b(a),g=!0}},vertexShaderParameters:{get:function(){return s}},vParams:{get:function(){return s}},fragmentShaderParameters:{get:function(){return t}},fParams:{get:function(){return t}},program:{get:function(){return d}}}),this.initialize=function(b){var c=this;if(g){var e=h.generate(),f=i.generate();d=a.loadProgram(b,e,f),Object.keys(j).forEach(function(a){var e=j[a],f=e.name,g=b.getAttribLocation(d,f),h="a"+a.charAt(0).toUpperCase()+a.substr(1,a.length),i=h+"Spec";c[h]=g,o[h]=g,c[i]=e}),Object.keys(k).forEach(function(a){var e=k[a],f=e.name,g=b.getUniformLocation(d,f),h="u"+a.charAt(0).toUpperCase()+a.substr(1,a.length),i=h+"Spec";c[h]=g,p[h]=g,c[i]=e}),Object.keys(l).forEach(function(d){var e=l[d],f=e.data,g=e.datatype,h=e.target,i=e.usage,j=(e.name,e.attribute),k=b.createBuffer();b.bindBuffer(b[h],k);var m="b"+d.charAt(0).toUpperCase()+d.substr(1,d.length),n=m+"Spec";switch(c[m]=k,q[m]=k,c[n]=e,g){case a.FLOAT32:e.Data=new Float32Array(f);break;case a.UINT16:e.Data=new Uint16Array(f);break;default:console.error("invalid datatype")}if(b.bufferData(b[h],e.Data,b[i]),e.applied=!0,e._data=e.data,Object.defineProperty(e,"data",{get:function(){return e._data},set:function(b){var c=e._data=b;if(b){switch(g){case a.FLOAT32:e.Data=new Float32Array(c);break;case a.UINT16:e.Data=new Uint16Array(c);break;default:console.error("invalid datatype")}e.applied=!1}}}),j){var o="a"+j.charAt(0).toUpperCase()+j.substr(1,j.length),p=o+"Spec",r=c[p];r.buffer=d}}),Object.keys(m).forEach(function(a){var d=m[a],e=d.image,f=d.type,g=(d.name,b.createTexture());b.bindTexture(b.TEXTURE_2D,g),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b[f],e);var h="t"+a.charAt(0).toUpperCase()+a.substr(1,a.length),i=h+"Spec";c[h]=g,r[h]=g,c[i]=d}),g=!1}},this.pushAttribute=function(a,b){var c="a"+b.charAt(0).toUpperCase()+b.substr(1,b.length),d=c+"Spec",e=this[c],f=this[d],g=f.buffer,h="b"+g.charAt(0).toUpperCase()+g.substr(1,g.length),i=h+"Spec",j=this[h],k=this[i],l=k.numComponents,m=k.type,n=k.normalize,o=k.stride,p=k.offset,q=k.target;a.bindBuffer(a[q],j),a.vertexAttribPointer(e,l,a[m],n,o,p),a.enableVertexAttribArray(e)},this.draw=function(a){e.initialize(a),Object.keys(l).forEach(function(b){var c=l[b];!c.applied&&c.Data&&a.bufferData(a[c.target],c.Data,a[c.usage])}),n&&n.call(e,a)}}return c}]).factory("oaWebglCanvas",function(){function a(a,b,c){var d,e,f=Object.assign({},c),g={},h=function(){b?(f.width&&f.height&&(b.width=f.width,b.height=f.height),d=b.getContext("webgl")):d=null};h(),Object.defineProperties(this,{canvas:{get:function(){return b},set:function(a){b=a,h()}},gl:{get:function(){return d}},main:{get:function(){return e},set:function(a){g[a]&&(e=a)}}}),this.registerProgram=function(a,b){g[a]=b,d&&b.initialize(d)},this.draw=function(a){if(d){a||(a=e?e:"main");var b=g[a];b&&b.draw(d)}}}return a});